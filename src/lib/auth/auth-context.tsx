'use client'

import React, { createContext, useContext, useEffect, useState } from 'react'
import { supabase } from '@/lib/supabase'
import { User, Session } from '@supabase/supabase-js'
import { logAuthError, logNetworkError, logInfo } from '@/lib/error-logger'

interface Profile {
  id: string
  email: string
  first_name: string
  last_name: string
  phone: string | null
  role: 'visitor' | 'client' | 'consultant' | 'admin' | 'staff'
  is_active: boolean
  email_verified: boolean
  created_at: string
  updated_at: string
  // Danƒ±≈üman i√ßin ek alanlar
  bio?: string
  specialties?: string[]
  certificates?: string[]
  profile_photo_url?: string
  document_urls?: string[]
  tc_no?: string
}

interface AuthContextType {
  user: User | null
  profile: Profile | null
  session: Session | null
  loading: boolean
  signIn: (email: string, password: string) => Promise<{ error: any; data?: any }>
  signUp: (email: string, password: string, userData: { first_name: string, last_name: string }) => Promise<{ error: any; data?: any }>
  signOut: () => Promise<void>
  updateProfile: (updates: Partial<Profile>) => Promise<{ error: any }>
  refreshSession: () => Promise<void>
  resendConfirmation: (email: string) => Promise<{ error: any }>
  resetPassword: (email: string) => Promise<{ error: any }>
  isAdmin: boolean
  isConsultant: boolean
  isClient: boolean
  isVisitor: boolean
  isStaff: boolean
  // Yeni √∂zellikler
  isAuthenticated: boolean
  isEmailVerified: boolean
  canAccessAdminPanel: boolean
  canAccessConsultantPanel: boolean
}

const AuthContext = createContext<AuthContextType | undefined>(undefined)

export function AuthProvider({ children }: { children: React.ReactNode }) {
  const [user, setUser] = useState<User | null>(null)
  const [profile, setProfile] = useState<Profile | null>(null)
  const [session, setSession] = useState<Session | null>(null)
  const [loading, setLoading] = useState(true)
  const [lastActivity, setLastActivity] = useState<number>(Date.now())



  // Database odaklƒ± rol kontrol√º - sadece profiles tablosundan
  // Ge√ßici admin email listesi (veritabanƒ± eri≈üimi olmadƒ±ƒüƒ± i√ßin)
  const adminEmails = ['ahmetyesildere@gmail.com']
  const isAdmin = profile?.role === 'admin' || adminEmails.includes(user?.email || '')
  const isConsultant = profile?.role === 'consultant'
  const isClient = profile?.role === 'client'
  const isVisitor = profile?.role === 'visitor'
  const isStaff = profile?.role === 'staff'

  // Yeni computed properties
  const isAuthenticated = !!user && !!session
  const isEmailVerified = true // Email doƒürulamasƒ± artƒ±k zorunlu deƒüil
  const canAccessAdminPanel = isAdmin && isAuthenticated
  const canAccessConsultantPanel = (isConsultant || isAdmin) && isAuthenticated

  // Debug loglarƒ±
  useEffect(() => {
    console.log('Auth state updated:')
    console.log('User:', user?.email)
    console.log('Profile:', profile)
    console.log('Is Admin:', isAdmin)
    console.log('Is Consultant:', isConsultant)
    console.log('Loading:', loading)
  }, [user, profile, isAdmin, isConsultant, loading])

  useEffect(() => {
    // Check if Supabase is properly configured
    console.log('Environment check:')
    console.log('NEXT_PUBLIC_SUPABASE_URL:', process.env.NEXT_PUBLIC_SUPABASE_URL)
    console.log('NEXT_PUBLIC_SUPABASE_ANON_KEY:', process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY ? 'Present' : 'Missing')

    if (!process.env.NEXT_PUBLIC_SUPABASE_URL || process.env.NEXT_PUBLIC_SUPABASE_URL === 'https://placeholder.supabase.co') {
      console.warn('Supabase is not configured. Auth features will be disabled.')
      setLoading(false)
      return
    }

    // Test Supabase connection
    console.log('Supabase URL:', process.env.NEXT_PUBLIC_SUPABASE_URL)
    console.log('Testing Supabase connection...')

    // Get initial session with timeout
    const sessionTimeout = setTimeout(() => {
      console.warn('‚è∞ Session loading timeout, setting loading to false')
      setLoading(false)
    }, 1000) // 1 saniye timeout

    supabase.auth.getSession().then(async ({ data: { session } }) => {
      clearTimeout(sessionTimeout)
      console.log('üì± Initial session loaded:', !!session)
      setSession(session)
      setUser(session?.user ?? null)

      if (session?.user) {
        // Admin email kontrol√º - hƒ±zlƒ± ge√ßi≈ü
        const adminEmails = ['ahmet@emelyesildere.com', 'ahmet.yesildere@gmail.com', 'ahmetyesildere@gmail.com']
        const isAdminEmail = adminEmails.includes(session.user.email || '')
        
        if (isAdminEmail) {
          // Admin i√ßin hƒ±zlƒ± loading false
          setLoading(false)
          // Profile'ƒ± arka planda y√ºkle
          fetchProfile(session.user.id, session.user)
        } else {
          // Diƒüer kullanƒ±cƒ±lar i√ßin normal y√ºkleme
          await fetchProfile(session.user.id, session.user)
        }
      } else {
        setLoading(false)
      }
    }).catch((error) => {
      clearTimeout(sessionTimeout)
      console.error('‚ùå Error getting session:', error)
      setLoading(false)
    })

    // Listen for auth changes
    const { data: { subscription } } = supabase.auth.onAuthStateChange(async (event, session) => {
      console.log('üîÑ Auth state change:', event, session?.user?.email)
      setSession(session)
      setUser(session?.user ?? null)

      if (session?.user) {
        // T√ºm kullanƒ±cƒ±lar i√ßin profile y√ºkle - loading'i hemen false yapma
        console.log('üë§ Profile y√ºkleniyor...', session.user.email)
        
        // Profile'ƒ± hemen y√ºkle, timeout'u kaldƒ±r
        try {
          await fetchProfile(session.user.id, session.user)
        } catch (error) {
          console.error('Profile y√ºkleme hatasƒ±:', error)
          setLoading(false)
        }
      } else {
        setProfile(null)
        setLoading(false)
      }
    })

    return () => subscription.unsubscribe()
  }, [])

  // Basit session tracking
  useEffect(() => {
    if (!session) return

    // Activity tracking - sadece temel events
    const updateActivity = () => {
      setLastActivity(Date.now())
    }

    const events = ['click', 'keypress']
    events.forEach(event => {
      document.addEventListener(event, updateActivity, true)
    })

    // Session durumunu kontrol et ve gerekirse refresh et
    const checkSession = async () => {
      try {
        const { data: { session: currentSession }, error } = await supabase.auth.getSession()

        if (error) {
          console.error('Session check error:', error)
          return
        }

        if (!currentSession) {
          console.log('Session expired, clearing auth state')
          setUser(null)
          setProfile(null)
          setSession(null)
          return
        }

        // Session expire zamanƒ±nƒ± kontrol et
        const expiresAt = currentSession.expires_at
        const now = Math.floor(Date.now() / 1000)
        const timeUntilExpiry = expiresAt ? expiresAt - now : 0

        console.log('Session check:', {
          expiresAt: new Date((expiresAt || 0) * 1000).toLocaleString(),
          timeUntilExpiry: `${Math.floor(timeUntilExpiry / 60)} minutes`,
          needsRefresh: timeUntilExpiry < 300 // 5 dakikadan az kaldƒ±ysa
        })

        // 5 dakikadan az kaldƒ±ysa session'ƒ± refresh et
        if (timeUntilExpiry < 300 && timeUntilExpiry > 0) {
          console.log('Session expiring soon, refreshing...')
          await refreshSession()
        }
      } catch (error) {
        console.error('Session check failed:', error)
      }
    }

    // ƒ∞lk kontrol
    checkSession()

    // Her 2 dakikada bir session kontrol et
    const sessionCheckInterval = setInterval(checkSession, 2 * 60 * 1000)

    // Cleanup
    return () => {
      events.forEach(event => {
        document.removeEventListener(event, updateActivity, true)
      })
      clearInterval(sessionCheckInterval)
    }
  }, [session])

  // Inactivity timeout - 30 dakika hareketsizlik sonrasƒ± uyar
  useEffect(() => {
    if (!session) return

    const checkInactivity = () => {
      const now = Date.now()
      const inactiveTime = now - lastActivity
      const thirtyMinutes = 30 * 60 * 1000

      if (inactiveTime > thirtyMinutes) {
        console.log('User inactive for 30+ minutes, showing warning')
        // Burada bir uyarƒ± modal'ƒ± g√∂sterebiliriz
        // ≈ûimdilik sadece console'da log'layalƒ±m
      }
    }

    const inactivityInterval = setInterval(checkInactivity, 5 * 60 * 1000) // Her 5 dakikada kontrol

    return () => clearInterval(inactivityInterval)
  }, [lastActivity, session])

  const loadRealProfile = async (userId: string, userEmail: string) => {
    try {
      const { data, error } = await supabase
        .from('profiles')
        .select('id, email, first_name, last_name, phone, role, is_active, email_verified, created_at, updated_at')
        .eq('id', userId)
        .single()

      if (!error && data) {
        console.log('‚úÖ Real admin profile loaded:', data)
        setProfile(data)
      }
    } catch (error) {
      console.log('‚ö†Ô∏è Real profile loading failed, keeping fallback')
    }
  }

  const fetchProfile = async (userId: string, currentUser?: User) => {
    try {
      console.log(`üîç Fetching profile for user ID: ${userId}`)
      const userEmail = currentUser?.email || user?.email || ''

      // Admin email kontrol√º - hƒ±zlƒ± fallback
      const adminEmails = ['ahmet@emelyesildere.com', 'ahmet.yesildere@gmail.com', 'ahmetyesildere@gmail.com']
      const isAdminEmail = adminEmails.includes(userEmail)
      
      if (isAdminEmail) {
        // Admin i√ßin hƒ±zlƒ± fallback profile
        const adminProfile: Profile = {
          id: userId,
          email: userEmail,
          first_name: 'Admin',
          last_name: 'User',
          phone: null,
          role: 'admin',
          is_active: true,
          email_verified: true,
          created_at: new Date().toISOString(),
          updated_at: new Date().toISOString()
        }
        
        setProfile(adminProfile)
        setUser(currentUser || user)
        setLoading(false)
        
        // Ger√ßek profili arka planda y√ºkle
        setTimeout(() => {
          loadRealProfile(userId, userEmail)
        }, 100)
        
        return
      }

      // √ñnce database'den y√ºklemeyi dene - FALLBACK YOK
      try {
        const { data, error } = await supabase
          .from('profiles')
          .select('id, email, first_name, last_name, phone, role, is_active, email_verified, created_at, updated_at')
          .eq('id', userId)
          .single()

        if (error) {
          console.log('‚ö†Ô∏è Database profile not found, creating fallback')
          throw error
        } else {
          console.log('‚úÖ Profile loaded from database:', data.email, 'Role:', data.role)
          // Profil ve user'ƒ± aynƒ± anda set et - b√∂ylece header'da email g√∂r√ºnmez
          setProfile(data)
          setUser(currentUser || user)
          setLoading(false)
          return
        }
      } catch (dbError) {
        console.log('‚ö†Ô∏è Database error, using email-based fallback')
        
        // Database'den y√ºklenemezse email'e g√∂re role belirle
        const adminEmails = ['ahmetyesildere@gmail.com']
        let defaultRole: 'visitor' | 'client' | 'consultant' | 'admin' | 'staff' = 'client'
        
        if (adminEmails.includes(userEmail)) {
          defaultRole = 'admin'
        } else if (userEmail.includes('emel') || userEmail === 'emelyesildere@gmail.com') {
          defaultRole = 'consultant'
        } else if (userEmail === 'meyitin633@bizmud.com') {
          defaultRole = 'client'
        }

        const fallbackProfile: Profile = {
          id: userId,
          email: userEmail,
          first_name: '',
          last_name: '',
          phone: null,
          role: defaultRole,
          is_active: true,
          email_verified: currentUser?.email_confirmed_at ? true : false,
          created_at: new Date().toISOString(),
          updated_at: new Date().toISOString()
        }

        console.log('üîß Using fallback profile with role:', defaultRole)
        setProfile(fallbackProfile)
      }

    } catch (error: any) {
      console.error('üí• Profile fetch exception:', error.message)
      
      // Son √ßare fallback
      const userEmail = currentUser?.email || user?.email || ''
      const fallbackProfile: Profile = {
        id: userId,
        email: userEmail,
        first_name: '',
        last_name: '',
        phone: null,
        role: 'client',
        is_active: true,
        email_verified: false,
        created_at: new Date().toISOString(),
        updated_at: new Date().toISOString()
      }

      console.log('üö® Using emergency fallback profile')
      setProfile(fallbackProfile)
    } finally {
      setLoading(false)
    }
  }

  const signIn = async (email: string, password: string) => {
    setLoading(true)

    try {
      console.log('üîê Starting signin process for:', email)

      const { data, error } = await supabase.auth.signInWithPassword({
        email: email.trim().toLowerCase(),
        password,
      })

      if (error) {
        console.error('‚ùå Signin error:', error.message)

        // Error'ƒ± logla
        logAuthError(`SignIn failed: ${error.message}`, {
          email: email.trim().toLowerCase(),
          errorCode: error.status,
          errorName: error.name
        }, user?.id)

        // Kullanƒ±cƒ± dostu hata mesajlarƒ±
        if (error.message.includes('Invalid login credentials') ||
          error.message.includes('Invalid email or password')) {
          return { error: { ...error, message: 'Email veya ≈üifre hatalƒ±' } }
        } else if (error.message.includes('Too many requests')) {
          return { error: { ...error, message: '√áok fazla deneme. L√ºtfen bekleyin' } }
        } else if (error.message.includes('Database error')) {
          return { error: { ...error, message: 'Sistem hatasƒ±. L√ºtfen tekrar deneyin' } }
        }
        // Email doƒürulama hatasƒ± artƒ±k g√∂z ardƒ± edilecek

        return { error }
      }

      if (data.user && data.session) {
        console.log('‚úÖ Signin successful:', data.user.id)
        // Profile otomatik y√ºklenecek via onAuthStateChange
        return { error: null, data }
      }

      return { error: { message: 'Giri≈ü ba≈üarƒ±sƒ±z. L√ºtfen tekrar deneyin.' } }
    } catch (error: any) {
      console.error('üí• Signin exception:', error)
      return { error: { message: 'Beklenmeyen bir hata olu≈ütu' } }
    } finally {
      setLoading(false)
    }
  }

  const signUp = async (email: string, password: string, userData: { first_name: string, last_name: string, phone?: string }) => {
    setLoading(true)

    try {
      console.log('üöÄ Starting signup process for:', email)

      // Email'i temizle ve normalize et
      const cleanEmail = email.trim().toLowerCase()

      // Input validation
      if (!cleanEmail || !password || !userData.first_name || !userData.last_name) {
        return { error: { message: 'T√ºm alanlar zorunludur' } }
      }

      if (password.length < 6) {
        return { error: { message: '≈ûifre en az 6 karakter olmalƒ±' } }
      }

      // Email format kontrol√º
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/
      if (!emailRegex.test(cleanEmail)) {
        return { error: { message: 'Ge√ßerli bir email adresi girin' } }
      }

      // T√ºm yeni kullanƒ±cƒ±lar client olarak ba≈ülar (spec'e uygun)
      const role: 'visitor' | 'client' | 'consultant' | 'admin' | 'staff' = 'client'

      const { data, error } = await supabase.auth.signUp({
        email: cleanEmail,
        password,
        options: {
          data: {
            first_name: userData.first_name.trim(),
            last_name: userData.last_name.trim(),
            phone: userData.phone || '',
            role: role
          },
          emailRedirectTo: `${window.location.origin}/auth/callback`
        }
      })

      console.log('üìß Supabase signup response:', {
        user: data.user?.id,
        session: !!data.session,
        error: error?.message
      })

      if (error) {
        console.error('‚ùå Auth signup error:', error.message)

        // Error'ƒ± logla
        logAuthError(`SignUp failed: ${error.message}`, {
          email: cleanEmail,
          firstName: userData.first_name,
          lastName: userData.last_name,
          errorCode: error.status,
          errorName: error.name
        })

        // Kullanƒ±cƒ± dostu hata mesajlarƒ±
        if (error.message.includes('User already registered') || error.message.includes('already registered')) {
          return { error: { ...error, message: 'Bu email adresi zaten kayƒ±tlƒ±. Giri≈ü yapmayƒ± deneyin.' } }
        } else if (error.message.includes('Invalid email')) {
          return { error: { ...error, message: 'Ge√ßersiz email adresi' } }
        } else if (error.message.includes('Password') || error.message.includes('password')) {
          return { error: { ...error, message: '≈ûifre gereksinimlerini kar≈üƒ±lamƒ±yor (en az 6 karakter)' } }
        } else if (error.message.includes('Database error')) {
          return { error: { ...error, message: 'Veritabanƒ± hatasƒ±. L√ºtfen tekrar deneyin.' } }
        } else if (error.message.includes('Network')) {
          return { error: { ...error, message: 'Baƒülantƒ± sorunu. ƒ∞nternet baƒülantƒ±nƒ±zƒ± kontrol edin.' } }
        }

        return { error }
      }

      if (data.user) {
        console.log('‚úÖ User created successfully:', data.user.id)

        // Email confirmation gerekiyorsa kullanƒ±cƒ±yƒ± bilgilendir
        if (!data.session) {
          console.log('üìß Email confirmation required')
          return {
            error: null,
            data: {
              ...data,
              needsEmailConfirmation: true,
              message: 'Kayƒ±t ba≈üarƒ±lƒ±! Email adresinizi kontrol edin ve doƒürulama linkine tƒ±klayƒ±n.'
            }
          }
        }

        // Trigger otomatik profil olu≈üturacak, manuel olu≈üturmaya gerek yok
        return { error: null, data }
      }

      return { error: { message: 'Kayƒ±t i≈ülemi tamamlanamadƒ±. L√ºtfen tekrar deneyin.' } }
    } catch (error: any) {
      console.error('üí• Signup exception:', error)

      // Network hatalarƒ±nƒ± yakala
      if (error.name === 'NetworkError' || error.message.includes('fetch')) {
        return { error: { message: 'Baƒülantƒ± sorunu. ƒ∞nternet baƒülantƒ±nƒ±zƒ± kontrol edin.' } }
      }

      return { error: { message: 'Beklenmeyen bir hata olu≈ütu. L√ºtfen tekrar deneyin.' } }
    } finally {
      setLoading(false)
    }
  }

  const signOut = async () => {
    console.log('üö™ Auth context √ßƒ±kƒ±≈ü yapƒ±lƒ±yor...')

    try {
      // √ñnce UI state'ini temizle
      setUser(null)
      setProfile(null)
      setSession(null)
      setLoading(false)

      // Storage'ƒ± temizle
      if (typeof window !== 'undefined') {
        try {
          localStorage.clear()
          sessionStorage.clear()
        } catch (e) {
          console.warn('Storage temizleme hatasƒ±:', e)
        }
      }

      // Supabase'den √ßƒ±kƒ±≈ü yap (timeout ile)
      try {
        const timeoutPromise = new Promise((_, reject) => 
          setTimeout(() => reject(new Error('Supabase signOut timeout')), 3000)
        )
        
        const signOutPromise = supabase.auth.signOut({ scope: 'global' })
        
        const { error } = await Promise.race([signOutPromise, timeoutPromise])
        
        if (error) {
          console.error('‚ùå Supabase √ßƒ±kƒ±≈ü hatasƒ±:', error)
        }
      } catch (timeoutError) {
        console.log('‚ö†Ô∏è Supabase signOut timeout, local √ßƒ±kƒ±≈ü tamamlandƒ±')
      }

      console.log('‚úÖ Auth context √ßƒ±kƒ±≈ü tamamlandƒ±')

      // Ana sayfaya y√∂nlendir
      if (typeof window !== 'undefined') {
        window.location.href = '/'
      }

    } catch (error) {
      console.error('‚ùå Auth context √ßƒ±kƒ±≈ü hatasƒ±:', error)
      
      // Hata durumunda da state'i temizle
      setUser(null)
      setProfile(null)
      setSession(null)
      setLoading(false)
      
      // Storage'ƒ± temizle
      if (typeof window !== 'undefined') {
        try {
          localStorage.clear()
          sessionStorage.clear()
        } catch (e) {
          console.warn('Storage temizleme hatasƒ±:', e)
        }
      }

      // Hata durumunda da ana sayfaya y√∂nlendir
      if (typeof window !== 'undefined') {
        window.location.href = '/'
      }
    }
  }

  const updateProfile = async (updates: Partial<Profile>) => {
    if (!user) return { error: new Error('No user logged in') }

    const { error } = await supabase
      .from('profiles')
      .update(updates)
      .eq('id', user.id)

    if (!error) {
      setProfile(prev => prev ? { ...prev, ...updates } : null)
    }

    return { error }
  }

  const refreshSession = async () => {
    try {
      console.log('üîÑ Refreshing session...')
      setLoading(true)

      const { data, error } = await supabase.auth.refreshSession()

      if (error) {
        console.error('‚ùå Session refresh failed:', error)
        // Session refresh ba≈üarƒ±sƒ±z olursa kullanƒ±cƒ±yƒ± √ßƒ±kƒ±≈ü yaptƒ±r
        await signOut()
        return
      }

      if (data.session) {
        console.log('‚úÖ Session refreshed successfully')
        setSession(data.session)
        setUser(data.session.user)
        setLastActivity(Date.now())

        // Profile'ƒ± da yeniden y√ºkle
        if (data.session.user) {
          await fetchProfile(data.session.user.id, data.session.user)
        } else {
          setLoading(false)
        }
      } else {
        setLoading(false)
      }
    } catch (error) {
      console.error('üí• Session refresh error:', error)
      setLoading(false)
      await signOut()
    }
  }

  const resendConfirmation = async (email: string) => {
    try {
      const { error } = await supabase.auth.resend({
        type: 'signup',
        email: email.trim().toLowerCase(),
        options: {
          emailRedirectTo: `${window.location.origin}/auth/callback`
        }
      })

      if (error) {
        console.error('‚ùå Resend confirmation error:', error.message)
        return { error: { message: 'Email g√∂nderimi ba≈üarƒ±sƒ±z' } }
      }

      console.log('‚úÖ Confirmation email resent')
      return { error: null }
    } catch (error: any) {
      console.error('üí• Resend confirmation exception:', error)
      return { error: { message: 'Email g√∂nderimi sƒ±rasƒ±nda hata olu≈ütu' } }
    }
  }

  const resetPassword = async (email: string) => {
    try {
      const { error } = await supabase.auth.resetPasswordForEmail(
        email.trim().toLowerCase(),
        {
          redirectTo: `${window.location.origin}/auth/reset-password`
        }
      )

      if (error) {
        console.error('‚ùå Reset password error:', error.message)
        return { error: { message: '≈ûifre sƒ±fƒ±rlama emaili g√∂nderilemedi' } }
      }

      console.log('‚úÖ Password reset email sent')
      return { error: null }
    } catch (error: any) {
      console.error('üí• Reset password exception:', error)
      return { error: { message: '≈ûifre sƒ±fƒ±rlama sƒ±rasƒ±nda hata olu≈ütu' } }
    }
  }

  const value = {
    user,
    profile,
    session,
    loading,
    signIn,
    signUp,
    signOut,
    updateProfile,
    refreshSession,
    resendConfirmation,
    resetPassword,
    isAdmin,
    isConsultant,
    isClient,
    isVisitor,
    isStaff,
    isAuthenticated,
    isEmailVerified,
    canAccessAdminPanel,
    canAccessConsultantPanel
  }

  return (
    <AuthContext.Provider value={value}>
      {children}
    </AuthContext.Provider>
  )
}

export function useAuth() {
  const context = useContext(AuthContext)
  if (context === undefined) {
    throw new Error('useAuth must be used within an AuthProvider')
  }
  return context
}